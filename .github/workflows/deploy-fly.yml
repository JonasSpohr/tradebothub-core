name: Deploy Bot to Fly.io

on:
  workflow_dispatch:
    inputs:
      fly_app:
        description: "Fly app name (e.g., tbh-bot-xxxx)"
        required: true
      image:
        description: "Full image ref (e.g., ghcr.io/org/repo:v1.2.3)"
        required: true
      region:
        description: "Fly region"
        required: false
        default: "ams"
      secrets_json:
        description: "JSON object of secrets to set on Fly app"
        required: false
        default: "{}"

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Install flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Ensure app exists
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          flyctl status --app "${{ inputs.fly_app }}" || flyctl apps create "${{ inputs.fly_app }}"

      - name: Set Fly secrets
        if: ${{ inputs.secrets_json != '{}' }}
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          echo '${{ inputs.secrets_json }}' > secrets.json
          python - <<'PY'
          import json, subprocess
          d=json.load(open("secrets.json"))
          if not isinstance(d, dict):
              raise SystemExit("secrets_json must be a JSON object")
          args=["flyctl","secrets","set"]
          for k,v in d.items():
              args.append(f"{k}={v}")
          args += ["--app","${{ inputs.fly_app }}"]
          subprocess.check_call(args)
          PY

      - name: Deploy pinned image
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          flyctl deploy \
            --app "${{ inputs.fly_app }}" \
            --image "${{ inputs.image }}" \
            --region "${{ inputs.region }}" \
            --ha=false