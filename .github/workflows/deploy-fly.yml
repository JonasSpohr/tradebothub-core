name: Deploy Bot to Fly.io

on:
  workflow_dispatch:
    inputs:
      fly_app:
        description: "Fly app name (e.g., tbh-bot-xxxx)"
        required: true
      image:
        description: "Full image ref (e.g., ghcr.io/org/repo:v1.2.3)"
        required: true
      region:
        description: "Fly region"
        required: false
        default: "ams"
      command:
        required: true
        type: string
      version_tag:
        required: true
        type: string
      bot_id:
        required: true
        type: string
      subscription_id:
        required: false
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Install flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Ensure app exists
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          flyctl status --app "${{ inputs.fly_app }}" || flyctl apps create "${{ inputs.fly_app }}"

      - name: Set Fly secrets
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
          BOT_ID: ${{ inputs.bot_id }}
          BOT_ENC_KEY: ${{ secrets.BOT_ENC_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          NEW_RELIC_LICENSE_KEY: ${{ secrets.NEW_RELIC_LICENSE_KEY }}
        run: |
          python - <<'PY'
          import os, subprocess

          base_required = ["BOT_ID", "BOT_ENC_KEY", "SUPABASE_URL", "SUPABASE_SERVICE_ROLE_KEY"]
          optional = ["NEW_RELIC_LICENSE_KEY"]

          missing_base = [k for k in base_required if not os.getenv(k)]
          if missing_base:
              raise SystemExit(f"Missing required secrets: {', '.join(missing_base)}")

          args = ["flyctl", "secrets", "set"]

          for k in base_required + optional:
              v = os.getenv(k)
              if v:
                  args.append(f"{k}={v}")

          args += ["--app", "${{ inputs.fly_app }}"]
          subprocess.check_call(args)
          PY

      - name: Deploy pinned image
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          flyctl deploy \
            --app "${{ inputs.fly_app }}" \
            --image "${{ inputs.image }}" \
            --region "${{ inputs.region }}" \
            --ha=false
